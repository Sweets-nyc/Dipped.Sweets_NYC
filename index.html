<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dipped Sweets NYC - Invoice Creator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Poppins (for headings), Inter (for body) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for the Inter font and basic body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFF8F0; /* Creamy white */
            color: #333333; /* Dark grey */
            line-height: 1.6;
            padding: 2rem;
        }
        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
            color: #6F4E37; /* Chocolate Brown */
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 1000px; /* Wider container for invoice */
            margin: 0 auto;
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #F8A4B8; /* Soft Pink */
            box-shadow: 0 0 0 3px rgba(248, 164, 184, 0.3); /* Ring effect */
        }
        .btn-primary {
            background-color: #F8A4B8; /* Soft Pink */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            font-weight: 600;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #E28FA0; /* Darker Pink */
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #E0B400; /* Golden Yellow */
            color: #6F4E37; /* Chocolate Brown */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #FFD700; /* Brighter Golden Yellow */
            transform: translateY(-2px);
        }
        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr; /* Description, Qty, Unit Price, Total, Remove */
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px dashed #e5e7eb; /* gray-200 */
        }
        .item-row:last-child {
            border-bottom: none;
        }
        .invoice-output {
            background-color: #fcfcfc;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        .invoice-header, .invoice-footer {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        /* Added relative positioning for invoice-header to contain absolute logo */
        .invoice-header {
            position: relative;
        }
        .invoice-details, .invoice-items, .invoice-summary {
            margin-bottom: 1.5rem;
        }
        .invoice-items table {
            width: 100%;
            border-collapse: collapse;
        }
        .invoice-items th, .invoice-items td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
        }
        .invoice-items th {
            background-color: #F8E6DD; /* Light peach */
            font-weight: 600;
            color: #6F4E37;
        }
        .invoice-summary div {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
        }
        .invoice-summary div:last-child {
            font-weight: bold;
            font-size: 1.25rem;
            border-top: 2px solid #6F4E37;
            padding-top: 1rem;
            margin-top: 0.5rem;
        }
        /* Message Box styles */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green for success */
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            font-size: 1rem;
            text-align: center;
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }
        .message-box.error {
            background-color: #f44336; /* Red for error */
        }
        /* Styles for hiding prices */
        .hidden-price {
            display: none !important;
        }
        /* Logo styling for screen output */
        #invoiceLogo {
            position: absolute;
            top: 1rem; /* Adjust as needed */
            left: 1rem; /* Adjust as needed */
            width: 80px; /* Size for screen */
            height: 80px; /* Size for screen */
            border-radius: 50%; /* Circular shape */
            object-fit: cover; /* Ensure image covers the area */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* Subtle shadow */
        }
        @media print {
            body {
                background-color: #fff;
                padding: 0.25rem; /* Further reduced padding for print */
                font-size: 8pt; /* Even smaller base font size for print */
                -webkit-print-color-adjust: exact; /* Ensure background colors print */
                print-color-adjust: exact;
            }
            .container {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
                max-width: 100%;
                width: 100%; /* Ensure it takes full width of paper */
            }
            .form-section, .btn-primary, .btn-secondary, .message-box {
                display: none !important; /* Hide form elements when printing */
            }
            .invoice-output {
                display: block !important; /* Ensure invoice output is visible */
                padding: 0; /* Remove padding from output section for print */
                margin-top: 0; /* Remove margin from output section for print */
                border: none; /* Remove border for cleaner print */
                box-shadow: none; /* Remove shadow for cleaner print */
            }
            h1, h2, h3, h4 {
                color: #333333 !important; /* Ensure black text for print */
                text-shadow: none !important; /* Remove text shadows */
            }
            .invoice-header {
                position: relative; /* Ensure positioning context */
                text-align: left; /* Align text to left for print */
                padding-top: 0.5rem; /* Add some padding at the top for print */
                padding-left: 90px; /* Make space for the logo on the left */
                margin-bottom: 0.8rem; /* Reduced margin */
            }
            .invoice-header h2 {
                font-size: 28pt; /* Larger for main title "INVOICE" */
                margin-bottom: 0.1rem; /* Reduced margin */
                color: #333333 !important; /* Ensure black text */
            }
            .invoice-header p {
                font-size: 9pt; /* Smaller text for company details */
                line-height: 1.2;
            }
            #invoiceLogo {
                position: absolute;
                top: 0.5rem; /* Adjust as needed for print */
                left: 0.5rem; /* Adjust as needed for print */
                width: 80px; /* Larger size for print */
                height: 80px; /* Larger size for print */
                border-radius: 50%;
                object-fit: cover;
                box-shadow: none; /* Remove shadow for print */
            }
            .invoice-details, .invoice-items, .invoice-summary, .invoice-notes, .invoice-delivery-info {
                margin-bottom: 0.5rem; /* Further reduced margins between sections */
            }
            .invoice-details h3, .invoice-items h3, .invoice-notes h3, .invoice-delivery-info h3 {
                font-size: 12pt; /* Even smaller sub-headings */
                margin-bottom: 0.3rem; /* Reduced margin */
            }
            .invoice-details p, .invoice-notes p, .invoice-delivery-info p {
                font-size: 9pt; /* Even smaller body text */
            }
            .invoice-items table, .invoice-items th, .invoice-items td {
                border: 1px solid #cccccc; /* Lighter border for print */
                font-size: 9pt; /* Even smaller table font size */
                padding: 0.3rem; /* Further reduced padding in table cells */
            }
            .invoice-items th {
                background-color: #f0f0f0 !important; /* Lighter background for print */
                color: #333333 !important;
            }
            .invoice-summary div {
                padding: 0.2rem 0; /* Further reduced padding in summary lines */
                font-size: 9pt; /* Even smaller summary font size */
            }
            .invoice-summary div:last-child {
                font-size: 12pt; /* Grand total slightly larger, but overall smaller */
                padding-top: 0.5rem;
                margin-top: 0.3rem;
                border-top: 1px solid #6F4E37 !important; /* Thinner border for print */
            }
            .invoice-footer {
                font-size: 8pt; /* Even smaller footer font size */
                margin-top: 1rem; /* Reduced margin */
            }
            /* Ensure price columns are hidden if toggle is active */
            .output-price-column, .output-price-summary-line {
                display: none !important; /* This ensures they are hidden if the checkbox is checked */
            }
            /* If prices are NOT hidden, ensure they display correctly */
            body:not(.hide-prices-active) .output-price-column {
                display: table-cell !important;
            }
            body:not(.hide-prices-active) .output-price-summary-line {
                display: flex !important;
            }

            /* Styles for saved invoices list */
            .saved-invoice-card {
                background-color: #fefefe;
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem;
                padding: 1.5rem;
                margin-bottom: 1rem;
                box-shadow: 0 4px 10px rgba(0,0,0,0.05);
                cursor: pointer;
                transition: all 0.2s ease-in-out;
            }
            .saved-invoice-card:hover {
                box-shadow: 0 6px 15px rgba(0,0,0,0.1);
                transform: translateY(-2px);
            }
            .saved-invoice-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-weight: 600;
                color: #6F4E37;
            }
            .saved-invoice-details {
                margin-top: 1rem;
                border-top: 1px dashed #e5e7eb;
                padding-top: 1rem;
                display: none; /* Hidden by default */
            }
            .saved-invoice-details.show {
                display: block;
            }
            .saved-invoice-details p {
                margin-bottom: 0.5rem;
            }
            .saved-invoice-items table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1rem;
            }
            .saved-invoice-items th, .saved-invoice-items td {
                border: 1px solid #eee;
                padding: 0.5rem;
                text-align: left;
                font-size: 0.9rem;
            }
            .saved-invoice-items th {
                background-color: #F8E6DD;
                font-weight: 600;
                color: #6F4E37;
            }
        }
    </style>
</head>
<body>
    <!-- Message Box container -->
    <div id="messageBox" class="message-box fixed top-4 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[1000] opacity-0 transition-opacity duration-300 ease-in-out"></div>

    <div class="container">
        <h1 class="text-4xl font-bold mb-8 text-center">Dipped Sweets NYC - Invoice</h1>
        <p id="userIdDisplay" class="text-sm text-gray-500 text-center mb-4"></p>


        <!-- Invoice Input Form -->
        <div id="invoiceFormSection" class="form-section">
            <h2 class="text-3xl font-semibold mb-6">Invoice Details</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label for="invoiceNumber" class="block text-gray-700 text-sm font-bold mb-2">Invoice Number:</label>
                    <input type="text" id="invoiceNumber" placeholder="INV-001" value="INV-001">
                </div>
                <div>
                    <label for="invoiceDate" class="block text-gray-700 text-sm font-bold mb-2">Invoice Date:</label>
                    <input type="date" id="invoiceDate">
                </div>
                <div>
                    <label for="dueDate" class="block text-gray-700 text-sm font-bold mb-2">Due Date:</label>
                    <input type="date" id="dueDate">
                </div>
            </div>

            <h2 class="text-3xl font-semibold mb-6">Client Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label for="clientName" class="block text-gray-700 text-sm font-bold mb-2">Client Name:</label>
                    <input type="text" id="clientName" placeholder="John Doe">
                </div>
                <div>
                    <label for="clientEmail" class="block text-gray-700 text-sm font-bold mb-2">Client Email:</label>
                    <input type="email" id="clientEmail" placeholder="john.doe@example.com">
                </div>
                <div>
                    <label for="clientPhone" class="block text-gray-700 text-sm font-bold mb-2">Client Phone:</label>
                    <input type="tel" id="clientPhone" placeholder="(123) 456-7890">
                </div>
                <div class="md:col-span-2">
                    <label for="clientAddress" class="block text-gray-700 text-sm font-bold mb-2">Client Address:</label>
                    <textarea id="clientAddress" rows="3" placeholder="123 Sweet Street, New York, NY 10001"></textarea>
                </div>
            </div>

            <h2 class="text-3xl font-semibold mb-6">Order Items</h2>
            <div class="mb-6">
                <label for="itemCategory" class="block text-gray-700 text-sm font-bold mb-2">Select from Menu Category:</label>
                <select id="itemCategory" class="mb-4">
                    <option value="All">All Menu Items</option>
                    <option value="Dipped Strawberries">Dipped Strawberries</option>
                    <option value="Dipped Pretzels">Dipped Pretzels</option>
                    <option value="Cake Pops">Cake Pops</option>
                    <option value="Rice Crispy & Dipped Cupcakes">Rice Crispy & Dipped Cupcakes</option>
                    <option value="Individual Sample Cups">Individual Sample Cups</option>
                </select>

                <div id="menuItemsSelection" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <!-- Menu items will be dynamically loaded here -->
                </div>
            </div>

            <h3 class="text-2xl font-semibold mb-4">Add Custom Item (if not on menu)</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="md:col-span-2">
                    <label for="customItemDescription" class="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                    <input type="text" id="customItemDescription" placeholder="Custom Cake Design">
                </div>
                <div>
                    <label for="customItemQuantity" class="block text-gray-700 text-sm font-bold mb-2">Quantity:</label>
                    <input type="number" id="customItemQuantity" value="1" min="1">
                </div>
                <div class="price-field">
                    <label for="customItemUnitPrice" class="block text-gray-700 text-sm font-bold mb-2">Unit Price ($):</label>
                    <input type="number" id="customItemUnitPrice" value="0.00" min="0" step="0.01">
                </div>
                <div class="md:col-span-4 flex justify-end">
                    <button type="button" id="addCustomItemBtn" class="btn-secondary">Add Custom Item</button>
                </div>
            </div>

            <h3 class="text-2xl font-semibold mb-4">Invoice Items List</h3>
            <div id="invoiceItemsList" class="bg-gray-100 p-6 rounded-lg mb-8">
                <div class="item-row font-bold text-gray-800 border-b-2 border-gray-300 pb-2">
                    <div>Description</div>
                    <div class="text-center">Qty</div>
                    <div class="price-column text-right">Unit Price</div>
                    <div class="price-column text-right">Total</div>
                    <div></div>
                </div>
                <div id="itemsContainer">
                    <!-- Added items will appear here -->
                </div>
                <!-- Moved noItemsMessage outside itemsContainer so it's not overwritten -->
                <p id="noItemsMessage" class="text-center text-gray-500 py-4">No items added yet.</p>

                <div class="flex justify-end mt-4">
                    <div class="text-right text-lg font-bold text-gray-800 price-summary-line">
                        Subtotal: <span id="currentSubtotal">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label for="deliveryDate" class="block text-gray-700 text-sm font-bold mb-2">Delivery/Pickup Date:</label>
                    <input type="date" id="deliveryDate">
                </div>
                <div>
                    <label for="deliveryTime" class="block text-gray-700 text-sm font-bold mb-2">Delivery/Pickup Time:</label>
                    <input type="text" id="deliveryTime" placeholder="e.g., 2:00 PM - 3:00 PM">
                </div>
                <div class="md:col-span-2">
                    <label for="deliveryLocation" class="block text-gray-700 text-sm font-bold mb-2">Delivery/Pickup Location:</label>
                    <textarea id="deliveryLocation" rows="2" placeholder="Client's Address or Pickup Point"></textarea>
                </div>
                <div class="price-field">
                    <label for="deliveryFee" class="block text-gray-700 text-sm font-bold mb-2">Delivery Fee ($):</label>
                    <input type="number" id="deliveryFee" value="0.00" min="0" step="0.01">
                </div>
                <!-- New: Deposit Received Field -->
                <div class="price-field">
                    <label for="depositReceived" class="block text-gray-700 text-sm font-bold mb-2">Deposit Received ($):</label>
                    <input type="number" id="depositReceived" value="0.00" min="0" step="0.01">
                </div>
            </div>

            <div class="mb-8">
                <label for="invoiceNotes" class="block text-gray-700 text-sm font-bold mb-2">Notes / Special Instructions:</label>
                <textarea id="invoiceNotes" rows="4" placeholder="Any additional notes for the client or internal use."></textarea>
            </div>

            <div class="flex items-center justify-center gap-4 mb-8">
                <input type="checkbox" id="hidePricesToggle" class="h-5 w-5 text-[#F8A4B8] focus:ring-[#F8A4B8] border-gray-300 rounded">
                <label for="hidePricesToggle" class="text-gray-700 text-base font-bold">Hide Prices (for donations/quotes)</label>
            </div>

            <div class="flex justify-center gap-4">
                <button id="generateInvoiceBtn" class="btn-primary flex items-center">
                    Generate Invoice <i class="fas fa-file-invoice ml-2"></i>
                </button>
                <button id="resetFormBtn" class="btn-secondary flex items-center">
                    Reset Form <i class="fas fa-redo ml-2"></i>
                </button>
                <button id="viewSavedInvoicesBtn" class="btn-primary flex items-center" disabled>
                    View Saved Invoices <i class="fas fa-list-alt ml-2"></i>
                </button>
            </div>
        </div>

        <!-- Invoice Output Section (initially hidden) -->
        <div id="invoiceOutputSection" class="invoice-output hidden">
            <div class="invoice-header">
                <!-- Circular Logo Placeholder -->
                <img id="invoiceLogo" src="https://placehold.co/80x80/F8E6DD/6F4E37?text=DS" alt="Company Logo" class="absolute rounded-full object-cover">
                <h2 class="text-4xl font-bold text-[#6F4E37] mb-2">INVOICE</h2>
                <p class="text-gray-700 text-lg">Dipped Sweets NYC</p>
                <p class="text-gray-600 text-sm">Handcrafted Dipped Treats</p>
                <p class="text-gray-600 text-sm">DippedSweets.nyc@gmail.com | +1 (929) 323-9892</p>
                <p class="text-gray-600 text-sm">Serving The Bronx, Upper East Side & Upper West Side Manhattan, and Astoria, Queens</p>
            </div>

            <hr class="border-t-2 border-[#F8A4B8] my-6">

            <div class="invoice-details grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-800">
                <div>
                    <h3 class="text-xl font-semibold mb-2">Bill To:</h3>
                    <p id="outputClientName" class="font-medium"></p>
                    <p id="outputClientAddress"></p>
                    <p id="outputClientEmail"></p>
                    <p id="outputClientPhone"></p>
                </div>
                <div class="md:text-right">
                    <h3 class="text-xl font-semibold mb-2">Invoice Info:</h3>
                    <p><strong>Invoice #:</strong> <span id="outputInvoiceNumber"></span></p>
                    <p><strong>Date:</strong> <span id="outputInvoiceDate"></span></p>
                    <p><strong>Due Date:</strong> <span id="outputDueDate"></span></p>
                </div>
            </div>

            <div class="invoice-items my-8">
                <h3 class="text-xl font-semibold mb-4">Items:</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th class="text-center">Qty</th>
                            <th class="output-price-column text-right">Unit Price</th>
                            <th class="output-price-column text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="outputItemsTableBody">
                        <!-- Invoice items will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="invoice-summary text-right text-gray-800">
                <div class="output-price-summary-line">
                    <span>Subtotal:</span>
                    <span id="outputSubtotal">$0.00</span>
                </div>
                <div class="output-price-summary-line">
                    <span>Delivery Fee:</span>
                    <span id="outputDeliveryFee">$0.00</span>
                </div>
                <!-- New: Deposit Received Output -->
                <div class="output-price-summary-line">
                    <span>Deposit Received:</span>
                    <span id="outputDepositReceived">$0.00</span>
                </div>
                <div class="text-2xl text-[#6F4E37] output-price-summary-line">
                    <span>Grand Total:</span>
                    <span id="outputGrandTotal">$0.00</span>
                </div>
                <!-- New: Amount Due Output -->
                <div class="text-2xl text-[#F44336] font-bold output-price-summary-line"> <!-- Highlight in red for clarity -->
                    <span>Amount Due:</span>
                    <span id="outputAmountDue">$0.00</span>
                </div>
            </div>

            <div class="invoice-notes my-8">
                <h3 class="text-xl font-semibold mb-2">Notes:</h3>
                <p id="outputNotes" class="text-gray-700 italic"></p>
            </div>

            <div class="invoice-delivery-info my-8">
                <h3 class="text-xl font-semibold mb-2">Delivery/Pickup Details:</h3>
                <p><strong>Date:</strong> <span id="outputDeliveryDate"></span></p>
                <p><strong>Time:</strong> <span id="outputDeliveryTime"></span></p>
                <p><strong>Location:</strong> <span id="outputDeliveryLocation"></span></p>
            </div>

            <hr class="border-t-2 border-[#F8A4B8] my-6">

            <div class="invoice-footer text-gray-600 text-sm">
                <p>Thank you for your business!</p>
                <p>Please make payments to [Your Preferred Payment Method/Details Here]</p>
            </div>

            <div class="flex justify-center gap-4 mt-8">
                <button id="saveInvoiceBtn" class="btn-primary flex items-center" disabled>
                    Save Invoice <i class="fas fa-save ml-2"></i>
                </button>
                <button id="printInvoiceBtn" class="btn-primary flex items-center">
                    Print Invoice <i class="fas fa-print ml-2"></i>
                </button>
                <button id="backToFormBtn" class="btn-secondary flex items-center">
                    Back to Form <i class="fas fa-arrow-left ml-2"></i>
                </button>
                <!-- New: View Saved Invoices button in the output section -->
                <button id="viewSavedInvoicesFromOutputBtn" class="btn-primary flex items-center" disabled>
                    View Saved Invoices <i class="fas fa-list-alt ml-2"></i>
                </button>
            </div>
        </div>

        <!-- Saved Invoices Section (initially hidden) -->
        <div id="savedInvoicesSection" class="hidden">
            <h2 class="text-3xl font-semibold mb-6 text-center">Your Saved Invoices</h2>
            <div id="savedInvoicesList" class="space-y-4">
                <!-- Saved invoices will be loaded here -->
                <p id="noSavedInvoicesMessage" class="text-center text-gray-500 py-4 hidden">No invoices saved yet.</p>
            </div>
            <div class="flex justify-center mt-8">
                <button id="backToCreatorFromSavedBtn" class="btn-secondary flex items-center">
                    Back to Invoice Creator <i class="fas fa-arrow-left ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase variables (MANDATORY: use these global variables)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // Corrected the typo here: initialAuthToken should get its value from __initial_auth_token
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null; // To store the authenticated user ID
        let isFirebaseReady = false; // New flag to indicate Firebase is ready for operations

        console.log("Firebase Config (parsed):", firebaseConfig);
        console.log("App ID:", appId);
        console.log("Initial Auth Token:", initialAuthToken ? "Present" : "Not Present");

        // Function to enable Firebase-dependent buttons
        function enableFirebaseButtons() {
            document.getElementById('saveInvoiceBtn').disabled = false;
            document.getElementById('viewSavedInvoicesBtn').disabled = false;
            document.getElementById('viewSavedInvoicesFromOutputBtn').disabled = false; // Enable the new button
        }

        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) { // Check for apiKey presence
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase app, db, auth initialized successfully.");

                // Authenticate user and set isFirebaseReady flag
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `User ID (Authenticated): ${userId}`;
                        console.log("User authenticated:", userId);
                        isFirebaseReady = true; // Firebase is ready after auth state is known
                        enableFirebaseButtons();
                    } else {
                        try {
                            if (initialAuthToken) {
                                const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                                userId = userCredential.user.uid;
                                document.getElementById('userIdDisplay').textContent = `User ID (Custom Token): ${userId}`;
                                console.log("Signed in with custom token:", userId);
                            } else {
                                const userCredential = await signInAnonymously(auth);
                                userId = userCredential.user.uid;
                                document.getElementById('userIdDisplay').textContent = `User ID (Anonymous): ${userId}`;
                                console.log("Signed in anonymously:", userId);
                            }
                            isFirebaseReady = true; // Firebase is ready after auth attempt
                            enableFirebaseButtons();
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                            showMessage(`Authentication failed: ${error.message}. Save/Load functionality may be limited.`, true);
                            userId = crypto.randomUUID(); // Fallback to a random ID if auth fails
                            document.getElementById('userIdDisplay').textContent = `User ID (Auth Failed, Fallback): ${userId}`;
                            console.warn("Falling back to random User ID due to authentication failure.");
                            isFirebaseReady = true; // Still ready, but with fallback ID
                            enableFirebaseButtons(); // Enable even if fallback, to allow interaction (which will then show specific errors)
                        }
                    }
                    console.log("Firebase ready status:", isFirebaseReady);
                });
            } catch (initError) {
                console.error("Error initializing Firebase:", initError);
                showMessage(`Firebase initialization failed: ${initError.message}. Save/Load functionality disabled.`, true);
                userId = crypto.randomUUID(); // Fallback to a random ID if init fails
                document.getElementById('userIdDisplay').textContent = `User ID (Init Failed, Fallback): ${userId}`;
                console.warn("Falling back to random User ID due to Firebase initialization failure.");
                isFirebaseReady = true; // Mark as ready even if failed, to unblock UI, but operations will fail
                enableFirebaseButtons(); // Enable even if failed, to allow interaction (which will then show specific errors)
                console.log("Firebase ready status:", isFirebaseReady);
            }
        } else {
            console.warn("Firebase config not found or incomplete. Firestore features will be disabled.");
            showMessage("Firebase not configured. Save/Load functionality disabled.", true);
            userId = crypto.randomUUID(); // Generate a random ID even if Firebase isn't configured
            document.getElementById('userIdDisplay').textContent = `User ID (No Firebase Config): ${userId}`;
            isFirebaseReady = true; // Mark as ready, but features will be disabled
            enableFirebaseButtons(); // Enable buttons, but save/load will show "Firebase not configured"
            console.log("Firebase ready status:", isFirebaseReady);
        }


        // Data for your menu items (copied from your website's script)
        const sweetsData = [
            {
                img: "db0735d2-681f-466d-a5d5-a7fceae3664c.jpeg",
                title: "Classic Dipped Strawberries",
                description: "Fresh, juicy strawberries hand-dipped in premium milk, dark, or white chocolate.",
                simplePrice: 3.17, // Numeric for calculations
                partyPrice: 2.83, // Numeric for calculations
                category: "Dipped Strawberries",
                displayOnMainMenu: true
            },
            {
                img: "2b0fd04a-dfe1-42b1-b087-2e3c51fe7a3b.jpeg",
                title: "White Chocolate Drizzle Strawberries",
                description: "Fresh strawberries dipped in milk chocolate, elegantly drizzled with white chocolate.",
                simplePrice: 3.33,
                partyPrice: 3.00,
                category: "Dipped Strawberries",
                displayOnMainMenu: false
            },
            {
                img: "927b7bcd-ac6a-4c5b-b5b6-df40e195cf4e.jpeg",
                title: "Oreo Crunch Strawberries",
                description: "Strawberries dipped in white chocolate and coated with crushed Oreo cookies.",
                simplePrice: 3.50,
                partyPrice: 3.17,
                category: "Dipped Strawberries",
                displayOnMainMenu: false
            },
            {
                img: "5bc5629f-61c9-422b-8882-d1e3b3390d3e.jpeg",
                title: "Confetti Dream Strawberries",
                description: "Milk chocolate-dipped strawberries adorned with festive, colorful sprinkles.",
                simplePrice: 3.25,
                partyPrice: 2.92,
                category: "Dipped Strawberries",
                displayOnMainMenu: false
            },
            {
                img: "43MGOODAVXURGXTKKV6QSADP.webp",
                title: "Custom Dipped Strawberries",
                description: "Design your own! Choose your chocolate, toppings, and drizzles for a truly unique treat.",
                simplePrice: 0.00, // Price will be inquired, so set to 0 for calculation purposes
                partyPrice: 0.00,
                category: "Dipped Strawberries",
                displayOnMainMenu: false
            },
            {
                img: "Clean-Eating-Chocolate-Dipped-Strawberries-CleanFoodCrush.jpg",
                title: "Nuty Strawberries",
                description: "Fresh strawberries dipped in rich milk chocolate, adorned with dried cut nuts of your choice.",
                simplePrice: 3.42,
                partyPrice: 3.08,
                category: "Dipped Strawberries",
                displayOnMainMenu: false
            },
            {
                img: "c3a68bd5-1d2a-4bd7-8438-92e2190ad0ae.jpeg",
                title: "Chocolate Dipped Pretzels",
                description: "Crunchy pretzel twists coated in chocolate and sprinkled with joy.",
                simplePrice: 2.00,
                partyPrice: 1.67,
                category: "Dipped Pretzels",
                displayOnMainMenu: true
            },
            {
                img: "45819452-78ee-497a-96f1-3f913ffa95ff.jpeg",
                title: "Gourmet Pretzel Rods",
                description: "Long pretzel rods elegantly dipped and decorated with various toppings.",
                simplePrice: 2.33,
                partyPrice: 2.08,
                category: "Dipped Pretzels",
                displayOnMainMenu: true
            },
            {
                img: "7d70783c-71df-41f5-9a6f-1bb84b1dec8a.jpeg",
                title: "Classic Cake Pops",
                description: "Moist cake bites on a stick, hand-dipped in chocolate and decorated with sprinkles.",
                simplePrice: 3.17,
                partyPrice: 2.83,
                category: "Cake Pops",
                displayOnMainMenu: true
            },
            // Removed "Velvet Swirl Cake Pops"
            /*
            {
                img: "c7c5357a-99b0-439a-8213-04c22bc5b94e.jpeg",
                title: "Velvet Swirl Cake Pops",
                description: "Decadent red velvet cake pops with elegant white chocolate swirls.",
                simplePrice: 3.42,
                partyPrice: 3.08,
                category: "Cake Pops",
                displayOnMainMenu: false
            },
            */
            {
                img: "273f61a4-d741-4cb7-822f-0bf7e9edffb1.jpeg",
                title: "Brownie Batter Cake Pops",
                description: "Rich brownie-flavored cake pops dipped in dark chocolate and topped with mini chocolate chips.",
                simplePrice: 3.17,
                partyPrice: 2.83,
                category: "Cake Pops",
                displayOnMainMenu: false
            },
            {
                img: "94801b50-345d-4d51-afc8-73c332b3a0d6.jpeg",
                title: "Simple Chocolate Covered Oreos",
                description: "Classic Oreos dipped in smooth chocolate, available in various colors and simple drizzles.",
                simplePrice: 3.42,
                partyPrice: 3.08,
                category: "Cake Pops",
                displayOnMainMenu: false
            },
            {
                img: "793e79b7-20a1-46cf-afa0-5f55534205ee.jpeg",
                title: "Cookie Dough Cake Pops",
                description: "Sweet cookie dough cake pops dipped in milk chocolate, a delightful treat.",
                simplePrice: 3.42,
                partyPrice: 3.08,
                category: "Cake Pops",
                displayOnMainMenu: false
            },
            {
                img: "rice krispies.jpg",
                title: "Dipped Rice Crispy Treats",
                description: "Chewy rice crispy treats generously coated in rich chocolate and fun toppings.",
                simplePrice: 2.67,
                partyPrice: 2.33,
                category: "Rice Crispy & Dipped Cupcakes",
                displayOnMainMenu: true
            },
            {
                img: "a67682b1-e2ad-4e9b-8dce-a834af8df359.jpeg",
                title: "Mini Dipped Cupcakes",
                description: "Delightful mini cupcakes, frosted and then partially dipped in chocolate.",
                simplePrice: 3.00,
                partyPrice: 2.67,
                category: "Rice Crispy & Dipped Cupcakes",
                displayOnMainMenu: true
            },
            {
                img: "tres leches.jpg",
                title: "Tres Leches Cups (Sample)",
                description: "Small, moist sponge cakes soaked in three kinds of milk, a creamy delight.",
                simplePrice: 8.00,
                partyPrice: 7.00,
                category: "Individual Sample Cups",
                displayOnMainMenu: true
            },
            {
                img: "f2cc655a-26b1-4bb9-a9f2-4bc20d4f775d.jpeg",
                title: "Individual Flan Desserts (Sample)",
                description: "Rich, creamy caramel custard baked to perfection, a classic Latin dessert.",
                simplePrice: 7.00,
                partyPrice: 6.00,
                category: "Individual Sample Cups",
                displayOnMainMenu: true
            },
            // Removed "Silky Chocolate Mousse Cups (Sample)"
            /*
            {
                img: "66a024fc-b8a5-400f-afdf-47d5e30a07ac.jpeg",
                title: "Silky Chocolate Mousse Cups (Sample)",
                description: "Light and airy chocolate mousse, a perfect individual portion of indulgence.",
                simplePrice: 6.00,
                partyPrice: 4.00,
                category: "Individual Sample Cups",
                displayOnMainMenu: true
            },
            */
            {
                img: "b5b46884-95db-49c8-82e8-6ea5bdf01f69.jpeg",
                title: "Creme Brulee Cups (Sample)",
                description: "Creamy custard with a crisp caramelized sugar topping, served in individual cups.",
                simplePrice: 6.00,
                partyPrice: 4.00,
                category: "Individual Sample Cups",
                displayOnMainMenu: true
            },
            {
                img: "823f3f9d-c336-4992-b8f1-64ae3e2761e1.jpeg",
                title: "Dipped Churro Bites (Sample)",
                description: "Crispy churro bites, dipped in chocolate and dusted with cinnamon sugar.",
                simplePrice: 3.00,
                partyPrice: 2.00,
                category: "Individual Sample Cups",
                displayOnMainMenu: true
            }
        ];

        // Array to hold the items added to the current invoice
        let invoiceItems = [];

        // Function to display messages to the user
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = 'message-box show'; // Reset classes and show
            if (isError) {
                messageBox.classList.add('error');
            } else {
                messageBox.classList.remove('error');
            }

            // Hide the message after 3 seconds
            setTimeout(() => {
                messageBox.classList.remove('show');
                // Optional: clear text after fade out
                setTimeout(() => messageBox.textContent = '', 500);
            }, 3000);
        }

        // Function to control which sections are visible
        function showSection(sectionId) {
            const allSections = document.querySelectorAll('.form-section, .invoice-output, #savedInvoicesSection');
            allSections.forEach(section => {
                section.classList.add('hidden'); // Hide all sections
            });

            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.remove('hidden'); // Show the target section
            }
        }

        // Function to populate the menu items for selection
        function populateMenuItems(category = 'All') {
            const menuItemsContainer = document.getElementById('menuItemsSelection');
            let htmlContent = '';
            const filteredSweets = category === 'All' ? sweetsData : sweetsData.filter(sweet => sweet.category === category);

            if (filteredSweets.length === 0) {
                htmlContent = `<p class="col-span-full text-center text-gray-500">No items found in this category.</p>`;
            } else {
                filteredSweets.forEach(sweet => {
                    // Display both simple and party prices for selection
                    const simplePriceFormatted = sweet.simplePrice.toFixed(2);
                    const partyPriceFormatted = sweet.partyPrice.toFixed(2);

                    htmlContent += `
                        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex flex-col items-center text-center">
                            <img src="${sweet.img}" alt="${sweet.title}" onerror="this.onerror=null;this.src='https://placehold.co/100x75/F8E6DD/6F4E37?text=Image';" class="w-full h-20 object-cover rounded-md mb-2">
                            <h4 class="font-semibold text-sm text-[#6F4E37] mb-1">${sweet.title}</h4>
                            <p class="text-xs text-gray-600 mb-2 price-display">
                                <span class="font-bold">Simple:</span> $${simplePriceFormatted} |
                                <span class="font-bold">Party:</span> $${partyPriceFormatted}
                            </p>
                            <div class="flex items-center gap-2">
                                <input type="number" value="1" min="1" class="w-16 p-1 text-center text-sm border border-gray-300 rounded-md item-qty-input">
                                <select class="w-20 p-1 text-sm border border-gray-300 rounded-md item-price-type">
                                    <option value="simple">Simple</option>
                                    <option value="party">Party</option>
                                </select>
                                <button type="button" class="btn-secondary px-3 py-1 text-sm rounded-md add-menu-item-btn"
                                    data-title="${sweet.title}"
                                    data-simple-price="${sweet.simplePrice}"
                                    data-party-price="${sweet.partyPrice}"
                                    data-description="${sweet.description.replace(/"/g, '&quot;')}"
                                >Add</button>
                            </div>
                        </div>
                    `;
                });
            }
            menuItemsContainer.innerHTML = htmlContent;
            addMenuItemEventListeners(); // Attach event listeners after populating
            togglePriceVisibility(); // Apply price visibility setting after populating
        }

        // Attach event listeners to "Add" buttons for menu items
        function addMenuItemEventListeners() {
            document.querySelectorAll('.add-menu-item-btn').forEach(button => {
                button.onclick = function() {
                    const parentDiv = this.closest('.bg-white');
                    const qty = parseInt(parentDiv.querySelector('.item-qty-input').value);
                    const priceType = parentDiv.querySelector('.item-price-type').value;
                    const title = this.dataset.title;
                    const description = this.dataset.description;
                    const unitPrice = parseFloat(this.dataset[priceType + 'Price']);

                    if (isNaN(qty) || qty < 1) {
                        showMessage("Quantity must be at least 1.", true);
                        return;
                    }

                    // Always add as a new item, generate a unique ID
                    addItemToInvoice(title, description, qty, unitPrice);
                };
            });
        }

        // Function to add an item to the invoiceItems array and update the list
        function addItemToInvoice(description, fullDescription, quantity, unitPrice) {
            const calculatedUnitPrice = parseFloat(unitPrice);
            const total = calculatedUnitPrice * quantity;

            // Generate a unique ID for each item added using crypto.randomUUID()
            const newItem = {
                id: crypto.randomUUID(), // Using crypto.randomUUID() for unique string ID
                description: description,
                fullDescription: fullDescription,
                quantity: quantity,
                unitPrice: calculatedUnitPrice,
                total: total
            };

            invoiceItems.push(newItem); // Always add as a new item
            console.log("Current invoiceItems after adding:", JSON.parse(JSON.stringify(invoiceItems))); // Log the array content
            updateInvoiceItemsList();
            calculateAndDisplayCurrentTotals(); // Update totals after adding item
            showMessage(`Added "${description}" x${quantity} to invoice.`);
        }

        // Function to remove an item from the invoiceItems array by its unique ID
        function removeItemFromInvoice(itemId) {
            const initialLength = invoiceItems.length;
            invoiceItems = invoiceItems.filter(item => item.id !== itemId);
            if (invoiceItems.length < initialLength) {
                updateInvoiceItemsList();
                calculateAndDisplayCurrentTotals();
                showMessage(`Removed item from invoice.`);
            }
        }

        // Function to update an item's quantity directly in the list by its unique ID
        function updateItemQuantityInList(itemId, newQuantity) {
            newQuantity = parseInt(newQuantity);
            const itemToUpdate = invoiceItems.find(item => item.id === itemId);

            if (!itemToUpdate) {
                showMessage("Item not found.", true);
                return;
            }

            if (isNaN(newQuantity) || newQuantity < 1) {
                showMessage("Quantity must be at least 1.", true);
                // Revert to previous valid quantity if input is invalid
                updateInvoiceItemsList(); // This will re-render and reset the input field
                return;
            }

            itemToUpdate.quantity = newQuantity;
            itemToUpdate.total = itemToUpdate.unitPrice * newQuantity;
            updateInvoiceItemsList();
            calculateAndDisplayCurrentTotals(); // Update totals after quantity change
            showMessage(`Quantity for "${itemToUpdate.description}" updated to ${newQuantity}.`);
        }

        // Function to update the displayed list of invoice items
        function updateInvoiceItemsList() {
            const itemsContainer = document.getElementById('itemsContainer');
            const noItemsMessage = document.getElementById('noItemsMessage');
            let htmlContent = '';
            const hidePrices = document.getElementById('hidePricesToggle').checked;

            if (invoiceItems.length === 0) {
                if (noItemsMessage) noItemsMessage.style.display = 'block';
            } else {
                if (noItemsMessage) noItemsMessage.style.display = 'none';
                invoiceItems.forEach(item => {
                    htmlContent += `
                        <div class="item-row">
                            <div>${item.description}</div>
                            <div class="text-center">
                                <input type="number" value="${item.quantity}" min="1"
                                    onchange="updateItemQuantityInList('${item.id}', this.value)"
                                    class="w-20 p-1 text-center text-sm border border-gray-300 rounded-md">
                            </div>
                            <div class="price-column text-right">${hidePrices ? '' : '$' + item.unitPrice.toFixed(2)}</div>
                            <div class="price-column text-right">${hidePrices ? '' : '$' + item.total.toFixed(2)}</div>
                            <div class="text-center">
                                <button type="button" onclick="removeItemFromInvoice('${item.id}')" class="text-red-500 hover:text-red-700 text-lg">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            if (itemsContainer) itemsContainer.innerHTML = htmlContent;
            console.log("HTML content generated for itemsContainer:", htmlContent); // Log the generated HTML
            togglePriceVisibility(); // Apply visibility after updating the list
        }

        // Function to calculate and display current subtotal in the form section
        function calculateAndDisplayCurrentTotals() {
            let subtotal = invoiceItems.reduce((sum, item) => sum + item.total, 0);
            document.getElementById('currentSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            // Recalculate and update grand total and amount due based on current inputs
            const deliveryFee = parseFloat(document.getElementById('deliveryFee').value) || 0;
            const depositReceived = parseFloat(document.getElementById('depositReceived').value) || 0;
            const grandTotal = subtotal + deliveryFee;
            const amountDue = grandTotal - depositReceived;

            document.getElementById('outputSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('outputDeliveryFee').textContent = `$${deliveryFee.toFixed(2)}`;
            document.getElementById('outputDepositReceived').textContent = `$${depositReceived.toFixed(2)}`;
            document.getElementById('outputGrandTotal').textContent = `$${grandTotal.toFixed(2)}`;
            document.getElementById('outputAmountDue').textContent = `$${amountDue.toFixed(2)}`;

            togglePriceVisibility(); // Ensure visibility is correct after calculations
        }

        // Function to toggle the visibility of price-related elements
        function togglePriceVisibility() {
            const hidePrices = document.getElementById('hidePricesToggle').checked;

            // Toggle a class on the body to allow print CSS to react
            document.body.classList.toggle('hide-prices-active', hidePrices);


            // Toggle visibility in the input form's item list header
            document.querySelectorAll('.price-column').forEach(el => {
                el.style.display = hidePrices ? 'none' : 'block';
            });
            // Toggle visibility for individual price fields in custom item section
            document.querySelectorAll('.price-field').forEach(el => {
                el.style.display = hidePrices ? 'none' : 'block';
            });
            // Toggle visibility for the subtotal line in the input form
            const currentSubtotalLine = document.querySelector('#invoiceItemsList .price-summary-line');
            if (currentSubtotalLine) {
                currentSubtotalLine.style.display = hidePrices ? 'none' : 'flex';
            }

            // Toggle visibility in the invoice output section
            // These are now primarily controlled by the @media print CSS based on body class
            document.querySelectorAll('.output-price-column').forEach(el => {
                el.style.display = hidePrices ? 'none' : 'table-cell'; // Use table-cell for table headers/data
            });
            document.querySelectorAll('.output-price-summary-line').forEach(el => {
                el.style.display = hidePrices ? 'none' : 'flex';
            });
        }


        // Function to generate and display the invoice
        function generateInvoice() {
            // Get input values
            const invoiceNumber = document.getElementById('invoiceNumber').value || 'N/A';
            const invoiceDate = document.getElementById('invoiceDate').value || 'N/A';
            const dueDate = document.getElementById('dueDate').value || 'N/A';
            const clientName = document.getElementById('clientName').value || 'N/A';
            const clientEmail = document.getElementById('clientEmail').value || 'N/A';
            const clientPhone = document.getElementById('clientPhone').value || 'N/A';
            const clientAddress = document.getElementById('clientAddress').value || 'N/A';
            const deliveryDate = document.getElementById('deliveryDate').value || 'N/A';
            const deliveryTime = document.getElementById('deliveryTime').value || 'N/A';
            const deliveryLocation = document.getElementById('deliveryLocation').value || 'N/A';
            const deliveryFee = parseFloat(document.getElementById('deliveryFee').value) || 0;
            const depositReceived = parseFloat(document.getElementById('depositReceived').value) || 0;
            const invoiceNotes = document.getElementById('invoiceNotes').value || 'No additional notes.';
            const hidePrices = document.getElementById('hidePricesToggle').checked;


            // Basic validation
            if (!clientName || invoiceItems.length === 0) {
                showMessage("Please enter client name and add at least one item to generate invoice.", true);
                return;
            }

            // Calculate totals
            let subtotal = invoiceItems.reduce((sum, item) => sum + item.total, 0);
            let grandTotal = subtotal + deliveryFee;
            let amountDue = grandTotal - depositReceived;

            // Populate output fields
            document.getElementById('outputInvoiceNumber').textContent = invoiceNumber;
            document.getElementById('outputInvoiceDate').textContent = invoiceDate;
            document.getElementById('outputDueDate').textContent = dueDate;
            document.getElementById('outputClientName').textContent = clientName;
            document.getElementById('outputClientAddress').textContent = clientAddress.replace(/\n/g, '<br>');
            document.getElementById('outputClientEmail').textContent = clientEmail;
            document.getElementById('outputClientPhone').textContent = clientPhone;
            document.getElementById('outputDeliveryDate').textContent = deliveryDate;
            document.getElementById('outputDeliveryTime').textContent = deliveryTime;
            document.getElementById('outputDeliveryLocation').textContent = deliveryLocation.replace(/\n/g, '<br>');
            document.getElementById('outputNotes').textContent = invoiceNotes;

            // Populate invoice items table
            const outputItemsTableBody = document.getElementById('outputItemsTableBody');
            let itemsHtml = '';
            invoiceItems.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td>${item.description}</td>
                        <td class="text-center">${item.quantity}</td>
                        <td class="output-price-column text-right">${hidePrices ? '' : '$' + item.unitPrice.toFixed(2)}</td>
                        <td class="output-price-column text-right">${hidePrices ? '' : '$' + item.total.toFixed(2)}</td>
                    </tr>
                `;
            });
            outputItemsTableBody.innerHTML = itemsHtml;

            // Populate summary
            document.getElementById('outputSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('outputDeliveryFee').textContent = `$${deliveryFee.toFixed(2)}`;
            document.getElementById('outputDepositReceived').textContent = `$${depositReceived.toFixed(2)}`;
            document.getElementById('outputGrandTotal').textContent = `$${grandTotal.toFixed(2)}`;
            document.getElementById('outputAmountDue').textContent = `$${amountDue.toFixed(2)}`;

            // Show invoice output, hide form
            showSection('invoiceOutputSection');
            showMessage("Invoice generated successfully!");
            togglePriceVisibility(); // Apply visibility to the generated invoice
        }

        // Function to save the current invoice to Firestore
        async function saveInvoice() {
            if (!isFirebaseReady) {
                showMessage("Please wait, Firebase is still initializing.", true);
                console.warn("Save Invoice: Firebase not ready.");
                return;
            }
            if (!db || !userId) {
                showMessage("Firestore is not available or user ID is missing. Cannot save invoice.", true);
                console.error("Save Invoice Error: Firestore DB or User ID is null.", { db, userId });
                return;
            }

            // Collect all data from the *output* section to ensure it's the generated invoice
            const invoiceData = {
                invoiceNumber: document.getElementById('outputInvoiceNumber').textContent,
                invoiceDate: document.getElementById('outputInvoiceDate').textContent,
                dueDate: document.getElementById('outputDueDate').textContent,
                clientName: document.getElementById('outputClientName').textContent,
                clientAddress: document.getElementById('outputClientAddress').innerHTML.replace(/<br>/g, '\n'), // Convert <br> back to newline
                clientEmail: document.getElementById('outputClientEmail').textContent,
                clientPhone: document.getElementById('outputClientPhone').textContent,
                deliveryDate: document.getElementById('outputDeliveryDate').textContent,
                deliveryTime: document.getElementById('outputDeliveryTime').textContent,
                deliveryLocation: document.getElementById('outputDeliveryLocation').innerHTML.replace(/<br>/g, '\n'),
                notes: document.getElementById('outputNotes').textContent,
                subtotal: parseFloat(document.getElementById('outputSubtotal').textContent.replace('$', '')),
                deliveryFee: parseFloat(document.getElementById('outputDeliveryFee').textContent.replace('$', '')),
                depositReceived: parseFloat(document.getElementById('outputDepositReceived').textContent.replace('$', '')),
                grandTotal: parseFloat(document.getElementById('outputGrandTotal').textContent.replace('$', '')),
                amountDue: parseFloat(document.getElementById('outputAmountDue').textContent.replace('$', '')),
                hidePrices: document.getElementById('hidePricesToggle').checked,
                items: invoiceItems.map(item => ({ // Use the original invoiceItems array for full detail
                    description: item.description,
                    quantity: item.quantity,
                    unitPrice: item.unitPrice,
                    total: item.total
                })),
                savedAt: serverTimestamp(), // Firestore timestamp
                userId: userId // Store the user ID for security rules
            };

            try {
                // Collection path: /artifacts/{appId}/users/{userId}/invoices
                const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/invoices`), invoiceData);
                showMessage(`Invoice saved successfully! ID: ${docRef.id}`);
                console.log("Document written with ID: ", docRef.id);
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage(`Error saving invoice: ${e.message}`, true);
            }
        }

        // Function to load and display saved invoices from Firestore
        async function loadSavedInvoices() {
            if (!isFirebaseReady) {
                showMessage("Please wait, Firebase is still initializing.", true);
                console.warn("Load Invoices: Firebase not ready.");
                return;
            }
            if (!db || !userId) {
                showMessage("Firestore is not available or user ID is missing. Cannot load invoices.", true);
                console.error("Load Invoices Error: Firestore DB or User ID is null.", { db, userId });
                return;
            }

            const savedInvoicesList = document.getElementById('savedInvoicesList');
            const noSavedInvoicesMessage = document.getElementById('noSavedInvoicesMessage');
            savedInvoicesList.innerHTML = ''; // Clear previous list
            noSavedInvoicesMessage.classList.add('hidden'); // Hide no invoices message by default

            try {
                // Collection path: /artifacts/{appId}/users/{userId}/invoices
                const invoicesColRef = collection(db, `artifacts/${appId}/users/${userId}/invoices`);
                const q = query(invoicesColRef); // No orderBy to avoid index issues

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noSavedInvoicesMessage.classList.remove('hidden');
                    console.log("No saved invoices found for this user.");
                    return;
                }

                console.log(`Found ${querySnapshot.size} saved invoices.`);
                querySnapshot.forEach(doc => {
                    const invoice = doc.data();
                    const invoiceId = doc.id;
                    const savedDate = invoice.savedAt ? new Date(invoice.savedAt.seconds * 1000).toLocaleDateString() : 'N/A';
                    const hidePrices = invoice.hidePrices || false;

                    let itemsHtml = '';
                    if (invoice.items && invoice.items.length > 0) {
                        itemsHtml = `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th class="text-center">Qty</th>
                                        <th class="${hidePrices ? 'hidden-price' : ''} text-right">Unit Price</th>
                                        <th class="${hidePrices ? 'hidden-price' : ''} text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        invoice.items.forEach(item => {
                            itemsHtml += `
                                <tr>
                                    <td>${item.description}</td>
                                    <td class="text-center">${item.quantity}</td>
                                    <td class="${hidePrices ? 'hidden-price' : ''} text-right">${hidePrices ? '' : '$' + item.unitPrice.toFixed(2)}</td>
                                    <td class="${hidePrices ? 'hidden-price' : ''} text-right">${hidePrices ? '' : '$' + item.total.toFixed(2)}</td>
                                </tr>
                            `;
                        });
                        itemsHtml += `</tbody></table>`;
                    } else {
                        itemsHtml = '<p>No items listed for this invoice.</p>';
                    }

                    savedInvoicesList.innerHTML += `
                        <div class="saved-invoice-card" data-invoice-id="${invoiceId}">
                            <div class="saved-invoice-header">
                                <span>Invoice #: ${invoice.invoiceNumber}</span>
                                <span>Client: ${invoice.clientName}</span>
                                <span>Date: ${invoice.invoiceDate}</span>
                                <span class="${hidePrices ? 'hidden-price' : ''}">Grand Total: $${invoice.grandTotal.toFixed(2)}</span>
                                <i class="fas fa-chevron-down ml-2 transition-transform duration-300"></i>
                            </div>
                            <div class="saved-invoice-details">
                                <p><strong>Due Date:</strong> ${invoice.dueDate}</p>
                                <p><strong>Client Email:</strong> ${invoice.clientEmail}</p>
                                <p><strong>Client Phone:</strong> ${invoice.clientPhone}</p>
                                <p><strong>Client Address:</strong> ${invoice.clientAddress.replace(/\n/g, '<br>')}</p>
                                <p><strong>Delivery Date:</strong> ${invoice.deliveryDate}</p>
                                <p><strong>Delivery Time:</strong> ${invoice.deliveryTime}</p>
                                <p><strong>Delivery Location:</strong> ${invoice.deliveryLocation.replace(/\n/g, '<br>')}</p>
                                <p><strong>Notes:</strong> ${invoice.notes}</p>
                                <div class="saved-invoice-items">
                                    <h4>Items:</h4>
                                    ${itemsHtml}
                                </div>
                                <div class="text-right mt-4">
                                    <p class="${hidePrices ? 'hidden-price' : ''}"><strong>Subtotal:</strong> $${invoice.subtotal.toFixed(2)}</p>
                                    <p class="${hidePrices ? 'hidden-price' : ''}"><strong>Delivery Fee:</strong> $${invoice.deliveryFee.toFixed(2)}</p>
                                    <p class="${hidePrices ? 'hidden-price' : ''}"><strong>Deposit Received:</strong> $${invoice.depositReceived.toFixed(2)}</p>
                                    <p class="${hidePrices ? 'hidden-price' : ''} font-bold text-lg text-[#6F4E37]"><strong>Grand Total:</strong> $${invoice.grandTotal.toFixed(2)}</p>
                                    <p class="${hidePrices ? 'hidden-price' : ''} font-bold text-lg text-[#F44336]"><strong>Amount Due:</strong> $${invoice.amountDue.toFixed(2)}</p>
                                </div>
                                <p class="text-sm text-gray-500 mt-4">Saved On: ${savedDate}</p>
                            </div>
                        </div>
                    `;
                });

                // Add event listeners for expanding/collapsing saved invoice details
                document.querySelectorAll('.saved-invoice-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const details = this.querySelector('.saved-invoice-details');
                        const icon = this.querySelector('.fa-chevron-down');
                        if (details) {
                            details.classList.toggle('show');
                            icon.classList.toggle('rotate-180');
                        }
                    });
                });

                showMessage("Saved invoices loaded successfully!");
            } catch (e) {
                console.error("Error loading documents: ", e);
                showMessage(`Error loading invoices: ${e.message}`, true);
            }
        }


        // Function to reset the form
        function resetForm() {
            document.getElementById('invoiceFormSection').reset(); // Resets form fields
            invoiceItems = []; // Clear items array
            updateInvoiceItemsList(); // Update displayed list
            calculateAndDisplayCurrentTotals(); // Reset totals display
            document.getElementById('invoiceNumber').value = 'INV-001'; // Reset default invoice number
            document.getElementById('invoiceDate').value = '';
            document.getElementById('dueDate').value = '';
            document.getElementById('deliveryFee').value = '0.00';
            document.getElementById('depositReceived').value = '0.00';
            document.getElementById('hidePricesToggle').checked = false; // Uncheck hide prices
            togglePriceVisibility(); // Ensure prices are visible after reset
            showMessage("Form has been reset.");
            // Re-apply default notes and deposit on reset
            setInitialFormValues();
        }

        // Function to set initial form values including notes and deposit
        function setInitialFormValues() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('invoiceDate').value = `${year}-${month}-${day}`;

            // Pre-fill notes for the donation scenario
            document.getElementById('invoiceNotes').value = `Dietary Restrictions: Nut-free options only.

Regarding the tax acknowledgment letter: As a small business just starting out, we're not set up to utilize those kinds of tax deductions at this time.`;

            // Set default delivery fee and deposit
            document.getElementById('deliveryFee').value = '0.00';
            document.getElementById('depositReceived').value = '45.00';

            // Set default due date to October 21, 2025
            document.getElementById('dueDate').value = '2025-10-21';

            calculateAndDisplayCurrentTotals(); // Update totals based on these initial values
        }


        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            setInitialFormValues(); // Set initial values on load

            populateMenuItems('All'); // Initial population of menu items

            document.getElementById('itemCategory').addEventListener('change', function() {
                populateMenuItems(this.value);
            });

            document.getElementById('addCustomItemBtn').addEventListener('click', function() {
                const description = document.getElementById('customItemDescription').value.trim();
                const quantity = parseInt(document.getElementById('customItemQuantity').value);
                const unitPrice = parseFloat(document.getElementById('customItemUnitPrice').value);

                if (!description) {
                    showMessage("Please enter a description for the custom item.", true);
                    return;
                }
                if (isNaN(quantity) || quantity < 1) {
                    showMessage("Quantity for custom item must be at least 1.", true);
                    return;
                }
                if (isNaN(unitPrice) || unitPrice < 0) {
                    showMessage("Unit price for custom item must be a non-negative number.", true);
                    return;
                }

                // Always add as a new item, generate a unique ID
                addItemToInvoice(description, description, quantity, unitPrice);
                // Clear custom item fields after adding
                document.getElementById('customItemDescription').value = '';
                document.getElementById('customItemQuantity').value = '1';
                document.getElementById('customItemUnitPrice').value = '0.00';
            });

            document.getElementById('generateInvoiceBtn').addEventListener('click', generateInvoice);
            document.getElementById('resetFormBtn').addEventListener('click', resetForm);
            document.getElementById('printInvoiceBtn').addEventListener('click', function() {
                window.print();
            });
            document.getElementById('backToFormBtn').addEventListener('click', function() {
                showSection('invoiceFormSection'); // Go back to the main form
            });

            // Event listener for the Save Invoice button
            document.getElementById('saveInvoiceBtn').addEventListener('click', saveInvoice);

            // New: Event listener for the View Saved Invoices button
            document.getElementById('viewSavedInvoicesBtn').addEventListener('click', async function() {
                showSection('savedInvoicesSection');
                await loadSavedInvoices(); // Await loading to ensure UI is updated after data fetch
            });

            // New: Event listener for the Back to Creator from Saved Invoices button
            document.getElementById('backToCreatorFromSavedBtn').addEventListener('click', function() {
                showSection('invoiceFormSection'); // Go back to the main form
            });

            // New: Event listener for the View Saved Invoices button in the output section
            document.getElementById('viewSavedInvoicesFromOutputBtn').addEventListener('click', async function() {
                showSection('savedInvoicesSection');
                await loadSavedInvoices(); // Await loading to ensure UI is updated after data fetch
            });

            // Listen for changes on the delivery fee and deposit input to update totals
            document.getElementById('deliveryFee').addEventListener('input', calculateAndDisplayCurrentTotals);
            document.getElementById('depositReceived').addEventListener('input', calculateAndDisplayCurrentTotals);

            // Listen for changes on the hide prices toggle
            document.getElementById('hidePricesToggle').addEventListener('change', togglePriceVisibility);

            // Initial call to set price visibility based on default toggle state
            togglePriceVisibility();
        });
    </script>
</body>
</html>
